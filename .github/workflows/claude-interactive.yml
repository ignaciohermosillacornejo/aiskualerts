name: Claude Interactive

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  interact:
    if: |
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login != 'github-actions[bot]'

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: op://Dev/CLAUDE_CODE_OAUTH_TOKEN/credential

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Claude Response
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Respond to this @claude mention:

            ${{ github.event.comment.body }}

            Context: ${{ github.repository }} PR/Issue #${{ github.event.issue.number || github.event.pull_request.number }}

            You can:
            - Answer questions about the code
            - Explain implementation decisions
            - Make code changes if requested
            - Provide suggestions and alternatives

            If making code changes:
            - Commit with descriptive message
            - Push the changes
            - Confirm what you did

            Use `gh pr comment` or `gh issue comment` to reply.
            Read CLAUDE.md for project conventions.

          claude_args: '--model claude-sonnet-4-20250514 --allowedTools "Bash(git:*),Bash(gh:*),Read,Write,Edit,Grep,Glob"'

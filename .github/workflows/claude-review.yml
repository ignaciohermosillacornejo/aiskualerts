name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  push:
    branches: [main]

jobs:
  # Auto-rebase approved PRs when main is updated and they have merge conflicts
  auto-rebase-approved-prs:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find and rebase approved PRs with conflicts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find all open PRs that are approved and have merge conflicts
          approved_prs=$(gh pr list --state open --json number,headRefName,mergeable,reviewDecision \
            --jq '.[] | select(.reviewDecision == "APPROVED" and .mergeable == "CONFLICTING") | "\(.number) \(.headRefName)"')

          if [ -z "$approved_prs" ]; then
            echo "No approved PRs with merge conflicts found"
            exit 0
          fi

          echo "Found approved PRs with conflicts:"
          echo "$approved_prs"

          echo "$approved_prs" | while read -r pr_number branch; do
            [ -z "$pr_number" ] && continue
            echo "Processing PR #$pr_number (branch: $branch)"

            # Fetch and checkout the PR branch
            git fetch origin "$branch"
            git checkout "$branch"

            # Attempt to rebase onto main
            git fetch origin main
            if git rebase origin/main; then
              git push --force-with-lease origin "$branch"
              gh pr comment "$pr_number" --body "üîÑ Automatically rebased onto main to resolve merge conflicts."
              echo "‚úÖ Successfully rebased PR #$pr_number"
            else
              git rebase --abort
              gh pr comment "$pr_number" --body "‚ö†Ô∏è Automatic rebase failed due to conflicts that require manual resolution."
              echo "‚ùå Failed to rebase PR #$pr_number - manual intervention required"
            fi

            # Return to main for next iteration
            git checkout main
          done

  review:
    # Skip draft PRs, only run on pull_request events
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: op://Dev/CLAUDE_CODE_OAUTH_TOKEN/credential

      - name: AI Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            You are a code reviewer for the aiskualerts project.

            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR with focus on:

            1. **Code Quality** - Clean code, error handling, readability
            2. **Security** - Vulnerabilities, input validation, auth issues
            3. **Performance** - Bottlenecks, N+1 queries, memory leaks
            4. **Testing** - Coverage, edge cases, test quality
            5. **Project Standards** - Follow CLAUDE.md conventions

            For each issue found:
            - Post an inline comment on the specific line
            - Explain the problem clearly
            - Propose a code snippet showing the fix

            Format your review comments like this:
            **[AI Review]**
            **Issue:** <description>
            **Proposed Fix:**
            ```typescript
            // suggested code
            ```
            **Reasoning:** <why this improves the code>

            Use `gh pr diff` to see changes, then use `gh pr comment` for feedback.
            Be constructive. Praise good patterns too.

            After completing your review, you MUST submit an official PR review:

            - If NO blocking issues found (or only minor suggestions), run BOTH commands in sequence:
              1. First approve: gh pr review ${{ github.event.pull_request.number }} --approve -b "‚úÖ LGTM - No blocking issues found"
              2. Then enable auto-merge: gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch

            - If blocking issues found (security, bugs, or major quality issues):
              gh pr review ${{ github.event.pull_request.number }} --request-changes -b "‚ö†Ô∏è Please address the review comments before merging"

          claude_args: '--model claude-sonnet-4-20250514 --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh pr merge:*),Read,Grep,Glob"'

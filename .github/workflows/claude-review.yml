name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    # Skip draft PRs and Dependabot PRs (Dependabot doesn't have access to secrets)
    if: |
      github.event.pull_request.draft == false &&
      github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CLAUDE_CODE_OAUTH_TOKEN: op://Dev/CLAUDE_CODE_OAUTH_TOKEN/credential

      - name: AI Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          allowed_bots: 'claude'
          prompt: |
            You are a code reviewer for the aiskualerts project.

            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR with focus on:

            1. **Code Quality** - Clean code, error handling, readability
            2. **Security** - Vulnerabilities, input validation, auth issues
            3. **Performance** - Bottlenecks, N+1 queries, memory leaks
            4. **Testing** - Coverage, edge cases, test quality
            5. **Project Standards** - Follow CLAUDE.md conventions

            For each issue found:
            - Post an inline comment on the specific line
            - Explain the problem clearly
            - Propose a code snippet showing the fix

            Format your review comments like this:
            **[AI Review]**
            **Issue:** <description>
            **Proposed Fix:**
            ```typescript
            // suggested code
            ```
            **Reasoning:** <why this improves the code>

            Use `gh pr diff` to see changes, then use `gh pr comment` for feedback.
            Be constructive. Praise good patterns too.

            After completing your review, you MUST submit an official PR review:

            - If NO blocking issues found (or only minor suggestions):
              1. First, check if the PR has merge conflicts by running: gh pr view ${{ github.event.pull_request.number }} --json mergeable --jq '.mergeable'
              2. If mergeable is "CONFLICTING", rebase the branch onto main before approving:
                 - Run: git fetch origin main
                 - Run: git rebase origin/main
                 - If rebase succeeds, run: git push --force-with-lease origin HEAD
                 - If rebase fails due to conflicts, abort with: git rebase --abort (and note in your review that manual rebase is needed)
              3. Approve: gh pr review ${{ github.event.pull_request.number }} --approve -b "✅ LGTM - No blocking issues found"
              4. Enable auto-merge: gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch

            - If blocking issues found (security, bugs, or major quality issues):
              gh pr review ${{ github.event.pull_request.number }} --request-changes -b "⚠️ Please address the review comments before merging"

          claude_args: '--model claude-sonnet-4-20250514 --allowedTools "Bash(gh:*),Bash(git:*),Read,Grep,Glob"'

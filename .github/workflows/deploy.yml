name: Deploy to Hetzner

on:
  workflow_dispatch:  # Manual deployment only

jobs:
  deploy:
    name: Build and Deploy to Hetzner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Load SSH key and server IP from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          # Get SSH private key (preserve formatting with -n)
          mkdir -p ~/.ssh
          op read -n "op://Dev/HETZNER_SSH_KEY/private key" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Get server IP
          HETZNER_SERVER_IP=$(op read "op://Dev/HETZNER_SERVER_IP/credential")
          echo "HETZNER_SERVER_IP=$HETZNER_SERVER_IP" >> $GITHUB_ENV

          # Add server to known hosts
          ssh-keyscan -H "$HETZNER_SERVER_IP" >> ~/.ssh/known_hosts

          echo "✅ Loaded SSH key and server IP from 1Password"

      - name: Generate .env file from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          # Use op inject to generate .env from .env.tpl
          op inject -i .env.tpl -o .env
          chmod 600 .env

          echo "✅ Generated .env file with secrets from 1Password"

      - name: Build Docker image
        run: |
          docker build -t aiskualerts:latest .
          echo "✅ Docker image built successfully"

      - name: Export Docker image to tar
        run: |
          docker save aiskualerts:latest | gzip > aiskualerts.tar.gz
          ls -lh aiskualerts.tar.gz
          echo "✅ Docker image exported to tar.gz"

      - name: Transfer files to server
        run: |
          # Create deployment directory on server
          ssh root@"$HETZNER_SERVER_IP" "mkdir -p /opt/aiskualerts/backups"

          # Backup previous tar if it exists (for rollback)
          ssh root@"$HETZNER_SERVER_IP" "
            if [ -f /opt/aiskualerts/aiskualerts.tar.gz ]; then
              mv /opt/aiskualerts/aiskualerts.tar.gz /opt/aiskualerts/backups/aiskualerts-\$(date +%Y%m%d-%H%M%S).tar.gz
            fi
          "

          # Transfer new deployment files
          scp aiskualerts.tar.gz root@"$HETZNER_SERVER_IP":/opt/aiskualerts/
          scp .env root@"$HETZNER_SERVER_IP":/opt/aiskualerts/
          scp docker-compose.yml root@"$HETZNER_SERVER_IP":/opt/aiskualerts/
          scp nginx.conf root@"$HETZNER_SERVER_IP":/opt/aiskualerts/
          scp -r src/db root@"$HETZNER_SERVER_IP":/opt/aiskualerts/src/

          # Set permissions
          ssh root@"$HETZNER_SERVER_IP" "chmod 600 /opt/aiskualerts/.env"

          echo "✅ Files transferred to server"

      - name: Deploy on server
        run: |
          ssh root@"$HETZNER_SERVER_IP" << 'ENDSSH'
            set -euo pipefail
            cd /opt/aiskualerts

            # Load Docker image from tar
            echo "Loading Docker image..."
            docker load < aiskualerts.tar.gz

            # Stop existing containers
            echo "Stopping existing containers..."
            docker compose down || true

            # Start new containers
            echo "Starting containers..."
            docker compose up -d

            # Clean up old images
            docker image prune -f

            echo "✅ Deployment complete"
          ENDSSH

      - name: Verify deployment
        run: |
          ssh root@"$HETZNER_SERVER_IP" << 'ENDSSH'
            set -euo pipefail
            cd /opt/aiskualerts

            # Wait for application to be healthy
            echo "Waiting for application to be healthy..."
            for i in {1..30}; do
              if curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "✅ Application is healthy!"
                docker compose ps
                exit 0
              fi
              echo "Waiting... ($i/30)"
              sleep 2
            done

            echo "❌ Application failed health check"
            docker compose logs --tail=50
            exit 1
          ENDSSH

      - name: Cleanup old backups
        if: success()
        run: |
          # Keep only last 3 backups
          ssh root@"$HETZNER_SERVER_IP" << 'ENDSSH'
            cd /opt/aiskualerts/backups
            ls -t aiskualerts-*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm
          ENDSSH

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f .env
          rm -f aiskualerts.tar.gz
          rm -f ~/.ssh/id_ed25519
          echo "✅ Cleaned up sensitive files"

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Server: $HETZNER_SERVER_IP"
          echo "Branch: ${GITHUB_REF_NAME}"
          echo "Commit: ${GITHUB_SHA::8}"
          echo "Image: aiskualerts:latest"
